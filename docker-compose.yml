version: "3.9"

services:
  # ─── PostgreSQL Database ─────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: fairhire-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: fairhire
      POSTGRES_USER: fairhire
      POSTGRES_PASSWORD: fairhire_secret
    ports:
      - "5446:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fairhire"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - fairhire-net

  # ─── Redis (Celery broker + caching) ─────────────────────────
  redis:
    image: redis:7-alpine
    container_name: fairhire-redis
    restart: unless-stopped
    ports:
      - "6346:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - fairhire-net

  # ─── Django Backend API ──────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fairhire-backend
    restart: unless-stopped
    command: >
      bash -c "python manage.py migrate --noinput &&
               python manage.py collectstatic --noinput &&
               python manage.py ensure_superuser &&
               gunicorn fairhire.wsgi:application --bind 0.0.0.0:8046 --workers 4 --timeout 300"
    environment:
      - DATABASE_URL=postgresql://fairhire:fairhire_secret@postgres:5432/fairhire
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - DJANGO_SECRET_KEY=change-me-in-production-abc123
      - DJANGO_DEBUG=True
      - DJANGO_ALLOWED_HOSTS=*
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    ports:
      - "8046:8046"
    volumes:
      - ./backend:/app
      - media_data:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fairhire-net

  # ─── Celery Worker (async agent tasks) ───────────────────────
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fairhire-celery-worker
    restart: unless-stopped
    command: celery -A fairhire worker -l info -c 4 -Q default,agents
    environment:
      - DATABASE_URL=postgresql://fairhire:fairhire_secret@postgres:5432/fairhire
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - DJANGO_SECRET_KEY=change-me-in-production-abc123
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    volumes:
      - ./backend:/app
      - media_data:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fairhire-net

  # ─── Celery Beat (scheduled tasks) ──────────────────────────
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fairhire-celery-beat
    restart: unless-stopped
    command: celery -A fairhire beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - DATABASE_URL=postgresql://fairhire:fairhire_secret@postgres:5432/fairhire
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - DJANGO_SECRET_KEY=change-me-in-production-abc123
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fairhire-net

  # ─── MCP Server (Model Context Protocol) ─────────────────────
  mcp-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fairhire-mcp-server
    restart: unless-stopped
    command: python manage.py run_mcp_server --host 0.0.0.0 --port 8146
    environment:
      - DATABASE_URL=postgresql://fairhire:fairhire_secret@postgres:5432/fairhire
      - REDIS_URL=redis://redis:6379/0
      - DJANGO_SECRET_KEY=change-me-in-production-abc123
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    ports:
      - "8146:8146"
    volumes:
      - ./backend:/app
      - media_data:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fairhire-net

  # ─── A2A Server (Agent-to-Agent Protocol) ────────────────────
  a2a-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fairhire-a2a-server
    restart: unless-stopped
    command: python manage.py run_a2a_server --host 0.0.0.0 --port 8246
    environment:
      - DATABASE_URL=postgresql://fairhire:fairhire_secret@postgres:5432/fairhire
      - REDIS_URL=redis://redis:6379/0
      - DJANGO_SECRET_KEY=change-me-in-production-abc123
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    ports:
      - "8246:8246"
    volumes:
      - ./backend:/app
      - media_data:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fairhire-net

  # ─── React Frontend ─────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: fairhire-frontend
    restart: unless-stopped
    ports:
      - "3047:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8046/api
      - REACT_APP_WS_URL=ws://localhost:8046/ws
      - REACT_APP_MCP_URL=http://localhost:8146
      - REACT_APP_A2A_URL=http://localhost:8246
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    depends_on:
      - backend
    networks:
      - fairhire-net

volumes:
  pgdata:
  media_data:

networks:
  fairhire-net:
    driver: bridge
